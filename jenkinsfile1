pipeline {
  agent any
  stages {
    stage('Docker Build') {
    	agent any
      steps {
      	sh 'docker build -t neelesh1/docker .'
      }
    }
    stage('Scan') {
        steps {
            // Install trivy
          
            sh 'curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/html.tpl > html.tpl'

            // Scan all vuln levels
            sh 'mkdir -p reports'
            sh 'trivy task --ignore-unfixed --vuln-type os,library --format template --template "@html.tpl" -o reports/task-scan.html ./task'
            publishHTML target : [
                allowMissing: true,
                alwaysLinkToLastBuild: true,
                keepAll: true,
                reportDir: 'reports',
                reportFiles: 'task-scan.html',
                reportName: 'Trivy Scan',
                reportTitles: 'Trivy Scan'
            ]

            // Scan again and fail on CRITICAL vulns
            sh 'trivy task --ignore-unfixed --vuln-type os,library --exit-code 1 --severity CRITICAL ./task'

        }
  }
}
